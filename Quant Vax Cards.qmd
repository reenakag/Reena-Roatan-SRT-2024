---
title: "Quant Vax Cards"
format: html
---

```{r}
library(tidyverse)
library(lubridate)
library(readxl)
library(googlesheets4)
library(broom)
```

```{r}
library(readr)
Consolidated_QUANT_Vax_Cards <- read_csv("Consolidated QUANT Vax Cards (no refuerzos, flu, vitA, varicella) - A+B Vax Cards MINUS Refuerzos, HepBs, Varicella.csv", 
    col_types = cols(date = col_date(format = "%d-%m-%y"), 
        dob = col_date(format = "%d-%m-%Y")))
View(Consolidated_QUANT_Vax_Cards)
```

```{r}
#| label: gender

# frequency table
Consolidated_QUANT_Vax_Cards |>
  count(gender) |>
  mutate(prop = n/sum(n))

# bar chart
Consolidated_QUANT_Vax_Cards |> ggplot(
  aes(x = gender, fill = gender)
) +
  geom_bar() +
  labs(title = "Genders of Children Accounted For", subtitle = "with Vaccine Cards")

# pie chart
slices <- c(122, 132, 16)
labels <- c("Female", "Male", "Unknown")
percent <- round(slices/sum(slices)*100)
labels <- paste(labels, percent)
labels <- paste(labels,"%",sep="") 
pie(slices, labels = labels, col = rainbow(length(labels)), main = "Pie Chart of Genders Survyed (with Vaccine Cards)")
  
```

```{r}
#| label: desired-vax-score

vax_score_tibble <- Consolidated_QUANT_Vax_Cards |>
  select(group, date, gender, dob) 

vax_score_tibble <- vax_score_tibble |>
  mutate(age_in_days = date - dob) |>
  mutate(age_in_years = as.numeric(age_in_days) / 365.25) |>
  mutate(age_rounded = round(age_in_years, 1))


vax_score_tibble <- vax_score_tibble |>
  mutate(desired_vax_score = if_else(age_rounded < 0.2, 2, 
                              if_else(age_rounded >= 0.2 & age_rounded < 0.3, 6,
                               if_else(age_rounded >= 0.3 & age_rounded < 0.5, 10,
                                if_else(age_rounded >= 0.5 & age_rounded < 1.0, 13, 
                                 if_else(age_rounded >= 1.0 & age_rounded < 1.5, 15,
                                  if_else(age_rounded >= 1.5 & age_rounded < 4, 18,
                                   if_else(age_rounded >= 4 & age_rounded < 11, 19,
                                    if_else(age_rounded >= 11 & gender == "M", 20,
                                     if_else(age_rounded >= 11 & gender == "F", 21, 0))))))))))

vax_score_tibble <- vax_score_tibble |>
  select(group, dob, age_rounded, desired_vax_score) 
vax_score_tibble

```

```{r}
#| label: actual-vax-score

vaccine_schedule <- Consolidated_QUANT_Vax_Cards 

vaccine_final <- tibble(
  survey_date = vaccine_schedule$date,
  group = vaccine_schedule$group,
  child_gender = vaccine_schedule$gender,
  child_dob = vaccine_schedule$dob,
  hep_b_status = ifelse(!is.na(vaccine_schedule$hep_b), "YES", "NO"),
  bcg_status = ifelse(!is.na(vaccine_schedule$bcg), "YES", "NO"),
  polio_vpi1_status = ifelse(!is.na(vaccine_schedule$polio_vpi1), "YES", "NO"),
  polio_vpi2_status = ifelse(!is.na(vaccine_schedule$polio_vpi2), "YES", "NO"),
  polio_vop1_status = ifelse(!is.na(vaccine_schedule$polio_vop1), "YES", "NO"),
  polio_vop2_status = ifelse(!is.na(vaccine_schedule$polio_vop2), "YES", "NO"),
  polio_vop3_status = ifelse(!is.na(vaccine_schedule$polio_vop3), "YES", "NO"),
  penta1_status = ifelse(!is.na(vaccine_schedule$penta1), "YES", "NO"),
  penta2_status = ifelse(!is.na(vaccine_schedule$penta2), "YES", "NO"),
  penta3_status = ifelse(!is.na(vaccine_schedule$penta3), "YES", "NO"),
  neumo1_status = ifelse(!is.na(vaccine_schedule$neumo1), "YES", "NO"),
  neumo2_status = ifelse(!is.na(vaccine_schedule$neumo2), "YES", "NO"),
  neumo3_status = ifelse(!is.na(vaccine_schedule$neumo3), "YES", "NO"),
  rota1_status = ifelse(!is.na(vaccine_schedule$rota1), "YES", "NO"),
  rota2_status = ifelse(!is.na(vaccine_schedule$rota2), "YES", "NO"),
  srp1_status = ifelse(!is.na(vaccine_schedule$srp1), "YES", "NO"),
  srp2_status = ifelse(!is.na(vaccine_schedule$srp2), "YES", "NO"),
  hep_a_status = ifelse(!is.na(vaccine_schedule$hep_a), "YES", "NO"),
  dpt1_status = ifelse(!is.na(vaccine_schedule$dpt1), "YES", "NO"),
  dpt2_status = ifelse(!is.na(vaccine_schedule$dpt2), "YES", "NO"),
  vph_1_status = ifelse(!is.na(vaccine_schedule$vph_1), "YES", "NO"),
  tetanus_dip_status = ifelse(!is.na(vaccine_schedule$tetanus_dip), "YES", "NO"))

vaccine_final <- vaccine_final |>
  rowwise() |>
  mutate(yes_count = sum(c_across(hep_b_status:tetanus_dip_status) == "YES"))
print(vaccine_final)

vaccine_final <- vaccine_final |>
  rename(dob = child_dob)

actual_vax_score <- vaccine_final |>
  as_tibble() |>
  select(group, dob, yes_count)

```

```{r}
#| label: join!

joined_vax_cards <- actual_vax_score |>
  left_join(vax_score_tibble, by = join_by(group))

```

```{r}
#| label: has-all-vax

joined_vax_cards <- joined_vax_cards |>
  mutate(complete = if_else(yes_count >= desired_vax_score, TRUE, FALSE))
joined_vax_cards

joined_vax_cards |>
  count(complete)
```

```{r}
#| label: percent-adherence-per-vax

new_tibble <- vax_score_tibble |>
  left_join(vaccine_final, by = join_by(group)) |>
  select(!c(group, dob.x, dob.y, survey_date, child_gender)) |>
  mutate(hep_b_should = if_else(age_rounded > 0, "YES", "NO")) |>
  mutate(hep_b_match = if_else(hep_b_status == hep_b_should, "YES", "NO")) 

match_tibble <- new_tibble |>
  count(hep_b_match)

num_yes_match <- match_tibble |>
  filter(hep_b_match == "YES") |>
  pull(n)
print(num_yes_match)

should_tibble <- new_tibble |>
  count(hep_b_should)

num_yes_should <- should_tibble |>
  filter(hep_b_should == "YES") |>
  pull(n)
print(num_yes_should)

percent_adherence = num_yes_match / num_yes_should
print(percent_adherence)

# take YES match vax1 / YES should vax1
  
```


